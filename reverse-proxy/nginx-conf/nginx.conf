# Global configuration
worker_processes auto;
error_log /opt/nginx/logs/error.log;


events {
    worker_connections 1024;
}

http {
    include ../conf/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;

    # --- GLOBAL PQC SSL/TLS Configuration ---
    ssl_protocols TLSv1.3;
    ssl_ciphers 'TLS_AES_256_GCM_SHA3_84:TLS_CHACHA20_POLY1305_SHA256:HIGH:!aNULL:!kRSA:!SHA1';
    ssl_session_cache   shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ecdh_curve X25519:secp384r1:X25519MLKEM768;
    ssl_prefer_server_ciphers on;
    ssl_session_tickets off; 

    # --- GLOBAL mTLS PROXY CONFIGURATION ---
    # 1. CA used to VERIFY backend servers
    proxy_ssl_trusted_certificate /opt/nginx/pki/ca.crt;
    
    # 2. CRL used to CHECK REVOCATION STATUS (MANDATORY FIX)
    proxy_ssl_crl                 /opt/nginx/pki/crl.pem;

    # 3. Client certificate NGINX PRESENTS to backend servers
    proxy_ssl_certificate         /opt/nginx/pki/nginx_pqc.crt;
    proxy_ssl_certificate_key     /opt/nginx/pki/nginx_pqc.key;
    # --- END mTLS ---

    server_tokens off; 

    
    # --- SERVER FOR API.CRYPTOASSIGNMENT.CORP (Backend API) ---
    server {
        # Listen on standard HTTP/HTTPS ports
        listen 80;
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name api.cryptoassignment.corp;

        access_log  /opt/nginx/logs/access.log;
        
        # Redirect HTTP to HTTPS
        if ($scheme = http) {
            return 301 https://$host$request_uri;
        }

        # Certs for the API domain (Mounted from ./certs/internal)
        ssl_certificate /opt/nginx/pki/api.cryptoassignment.corp.crt;
        ssl_certificate_key /opt/nginx/pki/api.cryptoassignment.corp.key;
        
        # Enforce HTTP Strict Transport Security (HSTS)
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
        # Enable CORS for requests from the frontend
        add_header 'Access-Control-Allow-Origin' 'https://www.cryptoassignment.corp' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;


        location / {

            # Handle preflight (OPTIONS) requests directly
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' 'https://www.cryptoassignment.corp' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
                add_header 'Access-Control-Max-Age' 3600;
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain; charset=UTF-8';
                return 204;
            }
            # Proxy to the API backend (MUST USE HTTPS for E2E-TLS)
            proxy_pass https://fastapi_app:8000;
            
            # Enables verification of the backend server's certificate against our trusted CA
            proxy_ssl_verify on;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # --- SERVER FOR WWW.CRYPTOASSIGNMENT.CORP (Frontend) ---
    server {
        listen 80;
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name www.cryptoassignment.corp;

        access_log  /opt/nginx/logs/access.log;

        # Redirect HTTP to HTTPS
        if ($scheme = http) {
            return 301 https://$host$request_uri;
        }

        # Certs for the WWW domain (Mounted from ./certs/internal to /opt/nginx/pki/)
        ssl_certificate /opt/nginx/pki/www.cryptoassignment.corp.crt;
        ssl_certificate_key /opt/nginx/pki/www.cryptoassignment.corp.key;

        # Enforce HTTP Strict Transport Security (HSTS)
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;

        location / {
            # Proxy to the Frontend backend (MUST USE HTTPS for E2E-TLS)
            proxy_pass https://frontend_app:443;
            
            # Enables verification of the backend server's certificate against our trusted CA
            proxy_ssl_verify on;
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # # --- SERVER FOR IDP.CRYPTOASSIGNMENT.CORP (Keycloak Public Endpoint) ---
    server {
        listen 80;
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name idp.cryptoassignment.corp;

        access_log  /opt/nginx/logs/access.log;

        # Redirect HTTP to HTTPS
        if ($scheme = http) {
            return 301 https://$host$request_uri;
        }

        # Certs for the IDP domain (Mounted from ./certs/internal to /opt/nginx/pki/)
        ssl_certificate /opt/nginx/pki/idp.cryptoassignment.corp.crt;
        ssl_certificate_key /opt/nginx/pki/idp.cryptoassignment.corp.key;

        # Enforce HTTP Strict Transport Security (HSTS)
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
        #location ~ ^/admin(/.*)?$ {
            # Ensure external clients cannot reach the admin portal
        #    return 403; 
        #}
        location / {
            # Proxy to Keycloak (MUST USE HTTPS for E2E-TLS internal port 8443)
            proxy_pass https://keycloak-app:8443;

            # Enables verification of the backend server's certificate against our trusted CA
            proxy_ssl_verify on;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure PQC Frontend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        .card { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .btn-primary { transition: background-color 0.2s, transform 0.1s; }
        .btn-primary:hover { background-color: #1e40af; transform: translateY(-1px); }
        .log-box { max-height: 200px; overflow-y: auto; background-color: #1f2937; color: #d1d5db; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="card w-full max-w-lg bg-white rounded-xl p-8 space-y-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">Crypto Assignment Client</h1>
        <p class="text-gray-500 text-center">Access the secured API via the PQC Nginx Reverse Proxy.</p>

        <!-- Login Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Authentication Flow</h2>
            <button id="loginButton" onclick="handleLogin()"
                class="btn-primary w-full bg-blue-600 text-white py-3 rounded-lg font-medium tracking-wide">
                1. Authenticate (Redirect to IDP)
            </button>
            <p class="text-sm text-gray-500 text-center">
                Redirects to <span class="font-mono text-xs text-blue-500">https://idp.cryptoassignment.corp</span> (Keycloak)
            </p>
        </div>

        <hr class="border-gray-200">

        <!-- API Consumption Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Protected API Call</h2>
            <button id="apiButton" onclick="fetchProtectedData()"
                class="w-full bg-green-600 text-white py-3 rounded-lg font-medium tracking-wide hover:bg-green-700 transition duration-150 ease-in-out">
                2. Call Secure API
            </button>
            <p class="text-sm text-gray-500 text-center">
                Calls <span class="font-mono text-xs text-green-500">https://api.cryptoassignment.corp/protected/shop-data</span>
            </p>
        </div>

        <!-- Output Log -->
        <div class="space-y-2">
            <h2 class="text-lg font-semibold text-gray-700">API Response Log</h2>
            <pre id="responseLog" class="log-box rounded-lg p-3 text-xs whitespace-pre-wrap"></pre>
        </div>
    </div>

    <script>
        const KEYCLOAK_ISSUER = "https://idp.cryptoassignment.corp/realms/crypto-realm";
        const CLIENT_ID = "crypto-frontend";
        const REDIRECT_URI = "https://www.cryptoassignment.corp/";
        const SCOPES = "openid profile email";

        const log = (message, type = 'info') => {
            const logElement = document.getElementById('responseLog');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-yellow-400';
            logElement.innerHTML += `<div class="${color} mb-1">${new Date().toLocaleTimeString()} [${type.toUpperCase()}]</div><div class="mb-2">${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        };

        // PKCE helpers
        function base64urlEncode(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function generatePKCEChallenge() {
            const verifier = [...crypto.getRandomValues(new Uint8Array(32))]
                .map(b => ('0' + b.toString(16)).slice(-2)).join('');
            const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
            const challenge = base64urlEncode(digest);
            return { verifier, challenge };
        }

        // Redirect to Keycloak for login
        async function handleLogin() {
            const { verifier, challenge } = await generatePKCEChallenge();
            localStorage.clear();

            localStorage.setItem('pkce_verifier', verifier);

            const authUrl = `${KEYCLOAK_ISSUER}/protocol/openid-connect/auth?` +
                `client_id=${CLIENT_ID}` +
                `&response_type=code` +
                `&scope=${encodeURIComponent(SCOPES)}` +
                `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
                `&code_challenge=${challenge}` +
                `&code_challenge_method=S256`;

            log('Redirecting to Keycloak for login...', 'info');
            window.location.href = authUrl;
        }

        // Handle Keycloak redirect
        async function handleRedirectCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (!code) return;

            const verifier = localStorage.getItem('pkce_verifier');
            if (!verifier) {
                log('Missing PKCE verifier!', 'error');
                return;
            }

            log('Exchanging code for tokens...', 'info');
            try {
                const form = new URLSearchParams();
                form.append('grant_type', 'authorization_code');
                form.append('client_id', CLIENT_ID);
                form.append('code', code);
                form.append('redirect_uri', REDIRECT_URI);
                form.append('code_verifier', verifier);

                const tokenResponse = await fetch(`${KEYCLOAK_ISSUER}/protocol/openid-connect/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: form
                });

                if (!tokenResponse.ok) throw new Error(`Token request failed: ${tokenResponse.status}`);
                const tokens = await tokenResponse.json();
                localStorage.setItem('access_token', tokens.access_token);
                localStorage.setItem('id_token', tokens.id_token);
                log('Login successful, tokens stored in localStorage.', 'success');

                // Clean URL
                window.history.replaceState({}, document.title, REDIRECT_URI);
            } catch (err) {
                log(err.message, 'error');
            }
        }

        // Call API with token
        async function fetchProtectedData() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                log('No access token found. Please login first.', 'error');
                return;
            }

            log('Calling secure API...', 'info');
            try {
                const response = await fetch('https://api.cryptoassignment.corp/protected/shop-data', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('API Call SUCCESS!', 'success');
                    log(`Data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log(`API Call FAILED! Status: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network/Fetch Error: ${error.message}`, 'error');
            }
        }

        // Run callback handler on load
        window.onload = handleRedirectCallback;
    </script>
</body>
</html>
